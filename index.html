<!doctype html>
<html lang="ru" class="h-full">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>HTML/CSS/JS –ü–µ—Å–æ—á–Ω–∏—Ü–∞</title>

    <!-- Tailwind (dark mode by class) -->
    <script>window.tailwind = window.tailwind || {}; window.tailwind.config = { darkMode: 'class' };</script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- CodeMirror + Lint -->
    <link rel="stylesheet" href="https://unpkg.com/codemirror@5.65.16/lib/codemirror.css" />
    <link rel="stylesheet" href="https://unpkg.com/codemirror@5.65.16/theme/material-darker.css" />
    <link rel="stylesheet" href="https://unpkg.com/codemirror@5.65.16/addon/lint/lint.css" />
    <script src="https://unpkg.com/codemirror@5.65.16/lib/codemirror.js"></script>
    <script src="https://unpkg.com/codemirror@5.65.16/mode/xml/xml.js"></script>
    <script src="https://unpkg.com/codemirror@5.65.16/mode/javascript/javascript.js"></script>
    <script src="https://unpkg.com/codemirror@5.65.16/mode/css/css.js"></script>
    <script src="https://unpkg.com/codemirror@5.65.16/mode/htmlmixed/htmlmixed.js"></script>
    <script src="https://unpkg.com/codemirror@5.65.16/addon/lint/lint.js"></script>
    <script src="https://unpkg.com/jshint@2.13.6/dist/jshint.js"></script>
    <script src="https://unpkg.com/csslint@1.0.5/dist/csslint.js"></script>
    <script src="https://unpkg.com/htmlhint@0.16.3/dist/htmlhint.js"></script>
    <script src="https://unpkg.com/codemirror@5.65.16/addon/lint/javascript-lint.js"></script>
    <script src="https://unpkg.com/codemirror@5.65.16/addon/lint/css-lint.js"></script>
    <script src="https://unpkg.com/codemirror@5.65.16/addon/lint/html-lint.js"></script>

    <meta name="color-scheme" content="dark light" />
    <style>
      html, body { height: 100%; }
      .CodeMirror { height: 60vh; }
      @media (min-width: 1024px) { .CodeMirror { height: 70vh; } }
      img.logo { image-rendering: -webkit-optimize-contrast; }
      .hidden-el { display: none; }
      .range { accent-color: #4f46e5; }
      .transition-theme { transition: background-color .2s ease, color .2s ease, border-color .2s ease; }
      /* Preview area */
      .device-viewport { transform-origin: top left; background: white; }
      .device-wrapper { position: relative; overflow-x: hidden; overflow-y: auto; }
      .device-badge { position: sticky; top: 6px; right: 8px; float: right; font-size: 10px; opacity: .7; margin: 6px 8px 0 0; }
    </style>
  </head>
  <body class="h-full transition-theme bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-100">
    <div class="min-h-screen p-4 md:p-6">
      <div class="max-w-[1400px] mx-auto">
        <header class="transition-theme rounded-2xl mb-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3 p-2 md:p-3 bg-white/70 border border-slate-200 backdrop-blur-sm dark:bg-slate-800/60 dark:border-slate-700">
          <div class="flex items-center gap-3">
            <img src="./logo.webp" alt="Logo" class="logo h-8 w-auto select-none" />
          </div>
          <div class="flex flex-wrap items-center gap-2">
            <button id="themeToggle" class="transition-theme px-3 py-2 rounded-2xl shadow-sm bg-slate-200 text-slate-900 hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600">üåû –°–≤–µ—Ç–ª–∞—è</button>
            <select id="deviceProfile" class="transition-theme px-3 py-2 rounded-2xl bg-slate-200 text-slate-900 dark:bg-slate-700 dark:text-slate-100">
              <option value="desk1440x900">–î–µ—Å–∫—Ç–æ–ø 1440√ó900 (16:10)</option>
              <option value="desk1920x1080">–î–µ—Å–∫—Ç–æ–ø 1920√ó1080 (16:9)</option>
              <option value="tab768x1024">–ü–ª–∞–Ω—à–µ—Ç 768√ó1024 (4:3)</option>
              <option value="mob375x812">–ú–æ–±–∏–ª—å–Ω—ã–π 375√ó812 (iPhone X)</option>
              <option value="mob360x800">–ú–æ–±–∏–ª—å–Ω—ã–π 360√ó800 (Android)</option>
            </select>
            <button id="orientationBtn" class="transition-theme px-3 py-2 rounded-2xl shadow-sm bg-slate-200 text-slate-900 hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600">‚Üª –û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è</button>
            <button id="runBtn" class="px-4 py-2 rounded-2xl shadow-md bg-indigo-600 hover:bg-indigo-500 active:scale-[.99] transition">‚ñ∂ –ó–∞–ø—É—Å–∫</button>
            <button id="exportBtn" class="px-4 py-2 rounded-2xl shadow-md bg-emerald-600 hover:bg-emerald-500 active:scale-[.99] transition">‚§ì –≠–∫—Å–ø–æ—Ä—Ç</button>
            <button id="importBtn" class="transition-theme px-4 py-2 rounded-2xl shadow-sm bg-slate-200 text-slate-900 hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600">‚§í –ò–º–ø–æ—Ä—Ç</button>
            <input id="fileInput" type="file" accept="application/json" class="hidden" />
          </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div class="transition-theme rounded-2xl bg-white border border-slate-200 overflow-hidden dark:bg-slate-800/60 dark:border-slate-700">
            <div class="transition-theme flex items-center justify-between gap-2 bg-slate-50 border-b border-slate-200 dark:bg-slate-900/60 dark:border-slate-700 px-2">
              <div class="flex items-center gap-1">
                <button data-tab="html" class="tab-btn px-4 py-2 text-sm md:text-base transition border-b-2 -mb-[1px] border-indigo-600 text-indigo-700 bg-indigo-50 dark:border-indigo-500 dark:text-indigo-300 dark:bg-slate-800">HTML</button>
                <button data-tab="css" class="tab-btn px-4 py-2 text-sm md:text-base transition border-b-2 -mb-[1px] border-transparent text-slate-600 hover:text-slate-900 hover:bg-slate-100 dark:text-slate-300 dark:hover:text-white dark:hover:bg-slate-700/50">CSS</button>
                <button data-tab="js" class="tab-btn px-4 py-2 text-sm md:text-base transition border-b-2 -mb-[1px] border-transparent text-slate-600 hover:text-slate-900 hover:bg-slate-100 dark:text-slate-300 dark:hover:text-white dark:hover:bg-slate-700/50">JS</button>
              </div>
              <div class="flex items-center gap-2 text-xs md:text-sm px-2 py-1">
                <span class="opacity-70">–ö–µ–≥–ª—å</span>
                <input id="fontSizeRange" class="range" type="range" min="12" max="24" step="1" value="14" />
                <span id="fontSizeValue" class="tabular-nums opacity-80">14px</span>
              </div>
            </div>
            <div class="p-0">
              <div id="htmlHost"></div>
              <div id="cssHost" class="hidden-el"></div>
              <div id="jsHost" class="hidden-el"></div>
            </div>
          </div>

          <div class="transition-theme rounded-2xl bg-white border border-slate-200 overflow-hidden flex flex-col dark:bg-slate-800/60 dark:border-slate-700">
            <div class="transition-theme px-4 py-2 text-sm border-b border-slate-200 flex items-center justify-between dark:border-slate-700">
              <span class="opacity-80">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</span>
              <span id="sizeBadge" class="opacity-60">iframe sandbox</span>
            </div>
            <div class="w-full flex justify-center p-3">
              <div id="previewArea" class="device-wrapper transition-theme border border-slate-200 dark:border-slate-700 rounded-xl shadow-sm max-w-full max-h-[70vh] bg-slate-100 dark:bg-slate-900">
                <div id="viewport" class="device-viewport">
                  <iframe id="preview" title="preview" class="w-full h-full bg-white dark:bg-slate-900" sandbox="allow-forms allow-modals allow-pointer-lock allow-popups allow-presentation allow-same-origin allow-scripts"></iframe>
                </div>
                <div class="device-badge" id="scaleBadge"></div>
              </div>
            </div>
          </div>
        </div>

        <section class="transition-theme mt-4 rounded-2xl bg-white border border-slate-200 overflow-hidden dark:bg-slate-800/60 dark:border-slate-700">
          <div class="transition-theme px-4 py-2 text-sm border-b border-slate-200 flex items-center justify-between dark:border-slate-700">
            <span class="opacity-80">–ö–æ–Ω—Å–æ–ª—å</span>
            <div class="flex items-center gap-2">
              <button id="clearConsole" class="text-xs px-2 py-1 rounded bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600">–û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
          </div>
          <div id="consoleOut" class="max-h-[30vh] overflow-auto font-mono text-xs p-3 space-y-1 bg-white dark:bg-slate-900">
            <div class="opacity-50">–í—ã–≤–æ–¥ –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ (–∏–ª–∏ –∏–∑ –∫–æ–¥–∞ —á–µ—Ä–µ–∑ console.log).</div>
          </div>
        </section>
      </div>
    </div>

    <script>
      (function(){
        const LS = { html:'play_html', css:'play_css', js:'play_js', theme: 'theme', fontSize: 'editor_fontsize', profile:'device_profile', orient:'device_orient' };
        const DEFAULTS = { html: '', css: '', js: '' };

        // Theme
        function applyTheme(t){
          const on = t==='dark';
          document.documentElement.classList.toggle('dark', on);
          document.body.classList.toggle('dark', on);
          localStorage.setItem(LS.theme, t);
          document.getElementById('themeToggle').textContent = on ? 'üåô –¢—ë–º–Ω–∞—è' : 'üåû –°–≤–µ—Ç–ª–∞—è';
          const cmTheme = on ? 'material-darker' : 'default';
          [cmHtml, cmCss, cmJs].forEach(cm => cm && cm.setOption('theme', cmTheme));
        }
        function initialTheme(){
          const saved=localStorage.getItem(LS.theme);
          if(saved==='light'||saved==='dark') return saved;
          return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }

        // Editors
        let cmHtml, cmCss, cmJs;
        function setEditorFontSize(px){
          document.getElementById('fontSizeValue').textContent = px + 'px';
          document.querySelectorAll('.CodeMirror').forEach(el => el.style.fontSize = px + 'px');
          [cmHtml, cmCss, cmJs].forEach(cm => cm && cm.refresh());
        }
        function initEditors(){
          const h = localStorage.getItem(LS.html);
          const c = localStorage.getItem(LS.css);
          const j = localStorage.getItem(LS.js);
          const theme = initialTheme()==='dark'?'material-darker':'default';
          cmHtml = CodeMirror(document.getElementById('htmlHost'), { value: h ?? DEFAULTS.html, mode:'htmlmixed', theme, lineNumbers:true, gutters:['CodeMirror-linenumbers','CodeMirror-lint-markers'], lint:true });
          cmCss  = CodeMirror(document.getElementById('cssHost'),  { value: c ?? DEFAULTS.css, mode:'css',        theme, lineNumbers:true, gutters:['CodeMirror-linenumbers','CodeMirror-lint-markers'], lint:true });
          cmJs   = CodeMirror(document.getElementById('jsHost'),   { value: j ?? DEFAULTS.js, mode:'javascript', theme, lineNumbers:true, gutters:['CodeMirror-linenumbers','CodeMirror-lint-markers'], lint:true });
          cmHtml.on('change', cm=>localStorage.setItem(LS.html, cm.getValue()));
          cmCss.on('change',  cm=>localStorage.setItem(LS.css,  cm.getValue()));
          cmJs.on('change',   cm=>localStorage.setItem(LS.js,   cm.getValue()));
          const fs = parseInt(localStorage.getItem(LS.fontSize) || '14', 10);
          document.getElementById('fontSizeRange').value = fs;
          setEditorFontSize(fs);
        }

        // Device profiles (CSS pixels)
        const PROFILES = {
          desk1440x900: { w:1440, h:900, label:'–î–µ—Å–∫—Ç–æ–ø 1440√ó900 (16:10)' },
          desk1920x1080:{ w:1920, h:1080, label:'–î–µ—Å–∫—Ç–æ–ø 1920√ó1080 (16:9)' },
          tab768x1024:  { w:768,  h:1024, label:'–ü–ª–∞–Ω—à–µ—Ç 768√ó1024 (4:3)' },
          mob375x812:   { w:375,  h:812,  label:'–ú–æ–±–∏–ª—å–Ω—ã–π 375√ó812 (iPhone X)' },
          mob360x800:   { w:360,  h:800,  label:'–ú–æ–±–∏–ª—å–Ω—ã–π 360√ó800 (Android)' },
        };
        let currentProfile = localStorage.getItem(LS.profile) || 'desk1920x1080';
        let orientation = localStorage.getItem(LS.orient) || 'portrait';

        function getDims(){
          const p = PROFILES[currentProfile] || PROFILES.desk1920x1080;
          return orientation==='portrait' ? { ...p } : { w:p.h, h:p.w, label: p.label + ' (landscape)' };
        }

        // Preview
        const viewport = () => document.getElementById('viewport');
        function updateViewportScale(){
          const area = document.getElementById('previewArea');
          const dims = getDims();
          viewport().style.width = dims.w + 'px';
          viewport().style.height = dims.h + 'px';
          const availW = area.clientWidth;
          const scale = Math.max(0.1, Math.min(1, availW / dims.w));
          viewport().style.transform = 'scale(' + scale + ')';
          area.style.minHeight = Math.ceil(dims.h * scale) + 'px';
          document.getElementById('scaleBadge').textContent = Math.round(dims.w) + '√ó' + Math.round(dims.h) + ' @' + (Math.round(scale*100)) + '%';
          document.getElementById('sizeBadge').textContent = '–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä ‚Ä¢ ' + pLabel();
        }
        function pLabel(){
          const p = PROFILES[currentProfile] || PROFILES.desk1920x1080;
          return p.label + (orientation==='landscape'?' (–∞–ª—å–±–æ–º–Ω–∞—è)':' (–ø–æ—Ä—Ç—Ä–µ—Ç)');
        }

        // Console capture & run
        function appendLog(level, text){
          const out = document.getElementById('consoleOut');
          const div = document.createElement('div');
          div.className = (level==='error' ? 'text-red-600 dark:text-red-400' :
                          level==='warn'  ? 'text-yellow-700 dark:text-yellow-300' :
                          level==='info'  ? 'text-sky-700 dark:text-sky-300' :
                                            'text-slate-700 dark:text-slate-200');
          div.innerHTML = '<span class="opacity-60">['+level+']</span> ' + text;
          out.appendChild(div);
          out.scrollTop = out.scrollHeight;
        }
        function clearLogs(){ document.getElementById('consoleOut').innerHTML = ''; }
        window.addEventListener('message', e => {
          const d=e.data; if(!d||!d.__sandboxLog) return;
          appendLog(d.type, (d.payload||[]).join(' '));
        });
        function buildSrcDoc(){
          const html = cmHtml.getValue();
          const css  = cmCss.getValue();
          const js   = cmJs.getValue();
          const esc = s => s.replace(/<\/script>/gi,'<\\/script>');
          return '<!doctype html><html lang=\"ru\"><head><meta charset=\"utf-8\"><meta name=\"viewport\" content=\"width=device-width, initial-scale=1\"><style>html,body{background:transparent;}'+esc(css)+'</style></head><body>'+html+
          '<script>(function(){var p=window.parent;function post(t,a){try{p.postMessage({__sandboxLog:true,type:t,payload:a},\"*\")}catch(e){}}[\"log\",\"info\",\"warn\",\"error\"].forEach(function(fn){var o=console[fn].bind(console);console[fn]=function(){var arr=[];for(var i=0;i<arguments.length;i++){try{arr.push(typeof arguments[i]===\"object\"?JSON.stringify(arguments[i]):String(arguments[i]))}catch(e){arr.push(String(arguments[i]))}}post(fn,arr);o.apply(console,arguments);};});window.addEventListener(\"error\",function(e){post(\"error\",[(e && e.message)||\"Error\",e.filename?e.filename+\":\"+e.lineno+\":\"+e.colno:\"\"]);});})();<\/script>'+
          '<script>try{'+js+'}catch(e){console.error(e && e.stack ? e.stack : e.toString());}<\/script></body></html>';
        }
        function run(){
          document.getElementById('preview').srcdoc = buildSrcDoc();
          appendLog('info','–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞‚Ä¶');
        }

        // Init
        document.addEventListener('DOMContentLoaded', function(){
          initEditors();
          applyTheme(initialTheme());
          switchTab('html');
          run();

          // Device UI
          var profileSel = document.getElementById('deviceProfile');
          profileSel.value = currentProfile;
          profileSel.addEventListener('change', function(e){
            currentProfile = e.target.value;
            localStorage.setItem(LS.profile, currentProfile);
            updateViewportScale();
          });
          document.getElementById('orientationBtn').addEventListener('click', function(){
            orientation = (orientation==='portrait') ? 'landscape' : 'portrait';
            localStorage.setItem(LS.orient, orientation);
            updateViewportScale();
          });

          // Theme & others
          document.getElementById('themeToggle').addEventListener('click', function(){
            var isDark = document.documentElement.classList.contains('dark') || document.body.classList.contains('dark');
            applyTheme(isDark ? 'light' : 'dark');
          });
          document.querySelectorAll('.tab-btn').forEach(function(btn){
            btn.addEventListener('click', function(){ switchTab(btn.getAttribute('data-tab')); });
          });
          document.getElementById('runBtn').addEventListener('click', run);
          document.getElementById('exportBtn').addEventListener('click', exportProject);
          document.getElementById('importBtn').addEventListener('click', function(){ document.getElementById('fileInput').click(); });
          document.getElementById('fileInput').addEventListener('change', function(e){
            var f=e.target.files&&e.target.files[0]; e.target.value=''; if(f) importProject(f).catch(function(err){ alert('–ò–º–ø–æ—Ä—Ç –Ω–µ —É–¥–∞–ª—Å—è: '+(err.message||err)); });
          });
          document.getElementById('clearConsole').addEventListener('click', clearLogs);

          // Font slider
          document.getElementById('fontSizeRange').addEventListener('input', function(e){
            var px = parseInt(e.target.value, 10); localStorage.setItem(LS.fontSize, px); setEditorFontSize(px);
          });

          // scaling on resize
          var ro = new ResizeObserver(updateViewportScale);
          ro.observe(document.getElementById('previewArea'));
          window.addEventListener('resize', updateViewportScale);
          updateViewportScale();

          // Hotkey
          window.addEventListener('keydown', function(e){
            if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 'enter') { e.preventDefault(); run(); }
          });
        });

        // Tabs helpers
        function setActiveTabButton(tab){
          document.querySelectorAll('.tab-btn').forEach(function(btn){
            var active = btn.getAttribute('data-tab')===tab;
            btn.classList.toggle('border-indigo-600', active);
            btn.classList.toggle('text-indigo-700', active);
            btn.classList.toggle('bg-indigo-50', active);
            btn.classList.toggle('dark:border-indigo-500', active);
            btn.classList.toggle('dark:text-indigo-300', active);
            btn.classList.toggle('dark:bg-slate-800', active);
            btn.classList.toggle('border-transparent', !active);
          });
        }
        function switchTab(tab){
          setActiveTabButton(tab);
          ['html','css','js'].forEach(function(name){
            var el = document.getElementById(name + 'Host');
            if(name === tab) el.classList.remove('hidden-el'); else el.classList.add('hidden-el');
          });
          setTimeout(function(){
            if(tab==='html') cmHtml.refresh();
            if(tab==='css') cmCss.refresh();
            if(tab==='js')  cmJs.refresh();
          },0);
        }

        // Export/Import
        function exportProject(){
          var payload = { version:1, html: cmHtml.getValue(), css: cmCss.getValue(), js: cmJs.getValue(), exportedAt: new Date().toISOString() };
          var blob = new Blob([JSON.stringify(payload, null, 2)], { type:'application/json' });
          var url = URL.createObjectURL(blob);
          var a = document.createElement('a'); a.href=url; a.download='playground-project-'+Date.now()+'.json'; a.click();
          URL.revokeObjectURL(url);
        }
        async function importProject(file){
          const text = await file.text();
          const data = JSON.parse(text);
          if(!data || typeof data.html!=='string' || typeof data.css!=='string' || typeof data.js!=='string') throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
          cmHtml.setValue(data.html); cmCss.setValue(data.css); cmJs.setValue(data.js);
          run();
        }
      })();
    </script>
  </body>
</html>
